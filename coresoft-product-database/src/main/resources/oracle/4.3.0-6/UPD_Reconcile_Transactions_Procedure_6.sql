--CREATE OR REPLACE
--PROCEDURE "UPD_RECONCILE_TRANSACTION" (FILENAME VARCHAR2)
--AS
--VAR_AHI_ID NUMBER;
--VAR_RT_ID NUMBER;
--LOOP_START NUMBER;
--COUNTER NUMBER DEFAULT 0;
--CURSOR RT_CUR
--IS
--SELECT ID,ACCOUNT_ID1,ACCOUNT_ID2,TRANSACTION_AMOUNT,PAN,TX_AMOUNT_FEE,REPL_TRAN,REPL_TRAN_FEE
--FROM RECONCILE_TRANSACTIONS WHERE
--MATCHED_FLAG=0 AND (MSG_TYPE IN ('0200','0220') OR (MSG_TYPE IN('0420') AND REPL_TRAN <> 0))
--AND PROCESSING_CD NOT LIKE '31%'
--AND RESPONSE_CD IN ('00','10')
--AND TRANSACTION_AMOUNT<>0 AND STAR_FILE_ID!=0 AND BUSINESS_DATE=SUBSTR(FILENAME, 9,4);
--TYPE RT_REC IS TABLE OF RT_CUR%ROWTYPE;
--RT_ROW RT_REC;
--BEGIN
--LOOP_START := DBMS_UTILITY.GET_TIME;
--RT_ROW := RT_REC();
--OPEN RT_CUR;
--LOOP
--FETCH RT_CUR BULK COLLECT INTO RT_ROW LIMIT 1000;
--EXIT WHEN RT_ROW.COUNT=0;
--FOR I IN 1..RT_ROW.COUNT
--LOOP
--BEGIN
--SELECT MAX(TRANSACTION_ID) INTO VAR_AHI_ID FROM ACCOUNT_HISTORY_ITEM AHI 
--WHERE (AHI.ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID1 OR AHI.ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID2)
--    AND SOURCE_NAME='DEBIT-CARD'
----    AND ABS(AHI.AMOUNT)= RT_ROW(I).TRANSACTION_AMOUNT
 --   AND SUBSTR(DESCRIPTION,-4,4)=SUBSTR(RT_ROW(I).PAN,-4,4)
 --   AND MATCHED_FLAG=0
 --   AND POSTED_TO=1
  --  AND HIDE_IN_STMT=0
  --  AND TRANS_CODE NOT IN (1019,1016,1010,1013,2024,1004) 
  --  AND  ENTRY_DATE>=TO_DATE((SUBSTR(FILENAME,9) ||' '||'03:00:00 PM'),'MM/DD/YY HH:MI:SS PM')-1 AND
--ENTRY_DATE<=TO_DATE((SUBSTR(FILENAME,9) ||' '||'02:59:59 PM'),'MM/DD/YY HH:MI:SS PM');
--IF(VAR_AHI_ID IS NOT NULL) THEN
--UPDATE RECONCILE_TRANSACTIONS RT SET RT.MATCHED_FLAG=1 WHERE RT.ID=RT_ROW(I).ID;
--UPDATE ACCOUNT_HISTORY_ITEM AHI SET AHI.MATCHED_FLAG=1 WHERE TRANSACTION_ID =VAR_AHI_ID;
--INSERT /*+ APPEND */ INTO MATCHED_REC_TRANSACTIONS VALUES(VAR_AHI_ID,RT_ROW(I).ID);
--END IF;
--VAR_AHI_ID := NULL;
--IF(TO_NUMBER(SUBSTR(RT_ROW(I).TX_AMOUNT_FEE,2,8)/100) !=0 ) THEN
--SELECT MAX(TRANSACTION_ID) INTO VAR_AHI_ID FROM ACCOUNT_HISTORY_ITEM
--WHERE (ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID1 OR ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID2)
--AND SOURCE_NAME='DEBIT-CARD'
--AND ABS(AMOUNT)=TO_NUMBER(SUBSTR(RT_ROW(I).TX_AMOUNT_FEE,2,8)/100)
--AND SUBSTR(DESCRIPTION,-4,4)=SUBSTR(RT_ROW(I).PAN,-4,4)
--AND MATCHED_FLAG=0
--AND POSTED_TO=1
--AND HIDE_IN_STMT=0
--AND TRANS_CODE NOT IN (1001,2022,2001,1025,1022)
--AND ENTRY_DATE>=TO_DATE((SUBSTR(FILENAME,9) ||' '||'03:00:00 PM'),'MM/DD/YY HH:MI:SS PM')-1 AND
--ENTRY_DATE<=TO_DATE((SUBSTR(FILENAME,9) ||' '||'02:59:59 PM'),'MM/DD/YY HH:MI:SS PM');
--IF(VAR_AHI_ID IS NOT NULL) THEN
--UPDATE RECONCILE_TRANSACTIONS RT SET RT.MATCHED_FLAG=1 WHERE RT.ID=RT_ROW(I).ID;
--UPDATE ACCOUNT_HISTORY_ITEM AHI SET AHI.MATCHED_FLAG=1 WHERE TRANSACTION_ID =VAR_AHI_ID;
--INSERT INTO MATCHED_REC_TRANSACTIONS VALUES(VAR_AHI_ID,RT_ROW(I).ID);
--END IF;
--END IF;
--VAR_AHI_ID := NULL;
--SELECT MAX(TRANSACTION_ID) INTO VAR_AHI_ID FROM ACCOUNT_HISTORY_ITEM AHI 
--WHERE (AHI.ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID1 OR AHI.ACCOUNT_NO=RT_ROW(I).ACCOUNT_ID2)
--    AND SOURCE_NAME='DEBIT-CARD'
--    AND ABS(AHI.AMOUNT)= RT_ROW(I).REPL_TRAN
 --   AND SUBSTR(DESCRIPTION,-4,4)=SUBSTR(RT_ROW(I).PAN,-4,4)
  --  AND MATCHED_FLAG=0
  --  AND POSTED_TO=1
  --  AND HIDE_IN_STMT=0
 --   AND  ENTRY_DATE>=TO_DATE((SUBSTR(FILENAME,9) ||' '||'03:00:00 PM'),'MM/DD/YY HH:MI:SS PM')-1 AND
--ENTRY_DATE<=TO_DATE((SUBSTR(FILENAME,9) ||' '||'02:59:59 PM'),'MM/DD/YY HH:MI:SS PM');
--IF(VAR_AHI_ID IS NOT NULL) THEN
--UPDATE RECONCILE_TRANSACTIONS RT SET RT.MATCHED_FLAG=1 WHERE RT.ID=RT_ROW(I).ID;
--UPDATE ACCOUNT_HISTORY_ITEM AHI SET AHI.MATCHED_FLAG=1 WHERE TRANSACTION_ID =VAR_AHI_ID;
--INSERT INTO MATCHED_REC_TRANSACTIONS VALUES(VAR_AHI_ID,RT_ROW(I).ID);
--END IF;
--IF(((DBMS_UTILITY.GET_TIME - LOOP_START)/100)>300) THEN
--COMMIT;
--LOOP_START := DBMS_UTILITY.GET_TIME;
--END IF;
--EXCEPTION
--WHEN OTHERS THEN
--NULL;
--END;
--END LOOP;

--END LOOP;
--COMMIT;
--DBMS_OUTPUT.PUT_LINE('TIME TAKEN FOR BULK EXECUTION : ' || (DBMS_UTILITY.GET_TIME - LOOP_START)/100||'SECONDS');
--CLOSE RT_CUR;
--END;